linux-2.6-version-$(cfg_linux_2_6_8_1) = 2.6.8.1
linux-2.6-version-$(cfg_linux_2_6_9) = 2.6.9
linux-2.6-version-$(cfg_linux_2_6_12_3) = 2.6.12.3
linux-2.6-version-$(cfg_linux_2_6_12_6) = 2.6.12.6
linux-2.6-version-$(cfg_linux_2_6_16_rc5) = 2.6.16-rc5
linux-2.6-version-$(cfg_linux_2_6_16) = 2.6.16
linux-2.6-version-$(cfg_linux_2_6_22) = 2.6.22

##  Which configurations of Linux do we build?
suffix-$(cfg_l4ka_vt) = -vt
suffix-$(cfg_apic) += -apic

linux-2.6-path-$(cfg_linux_2_6_16_rc5) = testing/

version_linux-2.6 := $(linux-2.6-version-y)
tarball_linux-2.6 = linux-$(version_linux-2.6).tar.bz2
url_linux-2.6 = http://www.kernel.org/pub/linux/kernel/v2.6/$(linux-2.6-path-y)$(tarball_linux-2.6)
unpack_linux-2.6 = linux-$(version_linux-2.6)$(suffix-y)

ifeq ($(cfg_l4ka_vt),y)
patch-file_linux-2.6 = $(afterburn_dir)/patches/linux/linux-2.6-seg-5.patch
else
patch-file_linux-2.6 = $(afterburn_dir)/patches/linux/linux-$(version_linux-2.6)-big-afterburn.patch
endif

install-$(cfg_linux_2_6) += install-linux-2.6
download-$(cfg_linux_2_6) += linux-2.6
patch-$(cfg_linux_2_6) += linux-2.6

.PHONY: install-linux-2.6 clean-linux-2.6 patch-linux-2.6 diff-linux-2.6 commit-linux-2.6 prereqs-patch-linux-2.6

clean:: clean-linux-2.6
install-linux-2.6::  
uninstall-linux-2.6::
clean-linux-2.6::
diff-linux-2.6::
commit-linux-2.6::
prereqs-patch-linux-2.6::
patch-linux-2.6:: receipts/patch-$(unpack_linux-2.6) prereqs-patch-linux-2.6 


##  The user can specify linux-2.6-extras on the command line.
linux-2.6-opts = INSTALL_MOD_PATH=$(cfg_usr_dir) $(linux-2.6-extras) $(MAKEOPTS) 

######################################################################
#  The Linux template
######################################################################
define linux-2.6-template
# Parameter $1: Linux configuration name
# Parameter $2: Linux build directory

.PHONY: install-linux-2.6-$1 clean-linux-2.6-$1 reconfig-linux-2.6-$1
install-linux-2.6:: install-linux-2.6-$1
clean-linux-2.6:: clean-linux-2.6-$1
uninstall-linux-2.6:: uninstall-linux-2.6-$1

reconfig-linux-2.6-$1: $2/.config
	$(Q) (cd $(cfg_src_dir)/$(unpack_linux-2.6) && make O=$2 $(linux-2.6-opts) menuconfig)

.PHONY: $(cfg_boot_dir)/vmlinuz-$(version_linux-2.6)-$1 \
	$(cfg_boot_dir)/bzImage-$(version_linux-2.6)-$1 \
	 $(cfg_boot_dir)/bootfloppy-$(version_linux-2.6)-$1

install-linux-2.6-$1: \
  $(cfg_boot_dir)/vmlinuz-$(version_linux-2.6)-$1 \
  $(cfg_boot_dir)/bzImage-$(version_linux-2.6)-$1 

ifeq ($(cfg_l4ka_vt),y)
install-linux-2.6-$1: \
  $(cfg_boot_dir)/bootfloppy-$(version_linux-2.6)-$1
endif

clean-linux-2.6-$1:
	-$(Q) (cd $(cfg_build_dir)/$(unpack_linux-2.6)-$1 && make clean)
uninstall-linux-2.6-$1:
	-$(Q) rm -f $(cfg_boot_dir)/vmlinuz-$(version_linux-2.6)-$1
	-$(Q) rm -f $(cfg_boot_dir)/bzImage-$(version_linux-2.6)-$1
	-$(Q) rm -f $2/arch/i386/boot/bzImage $2/vmlinuz


mtoolsrc-$(version_linux-2.6)-$1:
	echo 'drive y: file="$(cfg_boot_dir)/bootfloppy-$(version_linux-2.6)-$1"' > $$@

$(cfg_boot_dir)/bootfloppy-$(version_linux-2.6)-$1: \
	$(cfg_boot_dir)/bzImage-$(version_linux-2.6)-$1 \
	$(afterburn_dir)/contrib/grubdisk.img mtoolsrc-$(version_linux-2.6)-$1 
	@# Create a disk image
	@echo "Creating boot floppy for $$<"
	$(Q) /sbin/mkdosfs -C $$@ 1440
	$(Q) dd if=$(afterburn_dir)/contrib/grubdisk.img of=$$@ conv=notrunc > /dev/null
	$(Q) export MTOOLSRC=mtoolsrc-$(version_linux-2.6)-$1 ; \
		mcopy -o -m $$< y:vmlinuz || exit 0

$(cfg_boot_dir)/vmlinuz-$(version_linux-2.6)-$1: $2/vmlinuz
	$(Q) mkdir -p $(cfg_boot_dir)
	$(Q) cp $$< $$@
	$(Q) ln -sf $$(notdir $$@) $(cfg_boot_dir)/vmlinuz-$1

$(cfg_boot_dir)/bzImage-$(version_linux-2.6)-$1: $2/arch/i386/boot/bzImage
	$(Q) mkdir -p $(cfg_boot_dir)
	$(Q) cp $$< $$@
	$(Q) ln -sf $$(notdir $$@) $(cfg_boot_dir)/bzImage-$1

$2/vmlinuz: $2/vmlinux
	$(Q) strip -o $$(<D)/vmlinux.stripped $$(<D)/vmlinux
	$(Q) gzip -fc $$(<D)/vmlinux.stripped > $$(<D)/vmlinuz

.PHONY: $2/arch/i386/boot/bzImage
$2/vmlinux: $2/arch/i386/boot/bzImage
$2/arch/i386/boot/bzImage: $2/.config patch-linux-2.6
	@echo "Building Linux 2.6 in $2 opts $(linux-2.6-opts)"
	$(Q) mkdir -p $(cfg_usr_dir)
	$(Q) cd $(cfg_src_dir)/$(unpack_linux-2.6) && make O=$2 $(linux-2.6-opts)
	$(Q) if grep CONFIG_MODULES=y $2/.config ; then cd $(cfg_src_dir)/$(unpack_linux-2.6) && make O=$2 $(linux-2.6-opts) modules_install ; fi


$2/.config: $(afterburn_dir)/afterburn-wedge/doc/linux-2.6/dot-config-$(version_linux-2.6)-$1 \
						        $(cfg_common_dir)/config.out 
	@echo "Using config file $$<"
	$(Q) mkdir -p $$(@D)
##	$(Q) cd $$(@D) ; make clean
	$(Q) cat $$< | sed -e '{ s/CONFIG_LOCALVERSION=.*/CONFIG_LOCALVERSION="-$1"/g ; }' > $$@

commit-linux-2.6:: commit-linux-2.6-$1

commit-linux-2.6-$1: $2/.config
	@echo "Saving config file $$<"
	$(Q) cp $$< $(afterburn_dir)/afterburn-wedge/doc/linux-2.6/dot-config-$(version_linux-2.6)-$1

diff-linux-2.6:: diff-linux-2.6-$1

diff-linux-2.6-$1: $(afterburn_dir)/afterburn-wedge/doc/linux-2.6/dot-config-$(version_linux-2.6)-$1 $2/.config
	@echo "Diffing config files $$<"
	-$(Q) diff $$^

endef


linux-2.6-y =
linux-2.6-$(cfg_linux_2_6_driver) += driver$(suffix-y)
linux-2.6-$(cfg_linux_2_6_qemu) += qemu$(suffix-y)
linux-2.6-extra = $(subst ",,$(cfg_linux_2_6_extra))
linux-2.6-y += $(patsubst %,%$(suffix-y),$(linux-2.6-extra))

##  Instantiate the linux-2.6-template for each Linux configuration.
$(foreach name,$(linux-2.6-y),$(eval $(call linux-2.6-template,$(name),$(cfg_build_dir)/$(unpack_linux-2.6)-$(name))))


##  A utility to help extract a kernel config file from a kernel binary.
linux-2.6-binoffset = $(firstword $(wildcard $(foreach name,$(linux-2.6-y),$(cfg_build_dir)/$(unpack_linux-2.6)-$(name)/scripts/binoffset)))

