SOURCES_START = common/crtbegin.cc
SOURCES_END = common/crtend.cc

SOURCES += $(ARCH)/hthread.cc $(ARCH)/cpu.cc $(ARCH)/bind.cc \
	   common/elfsimple.cc common/hiostream.cc common/aftertime.cc \
	   common/gcc_support.cc common/memory.cc common/string.cc \
	   l4ka/startup.cc l4ka/l4privileged.cc l4ka/debug.cc \
	   l4ka/hthread.cc l4ka/vcpu.cc l4ka/main.cc l4ka/resourcemon.cc \
	   l4ka/module_manager.cc l4ka/$(ARCH)/backend.cc l4ka/$(ARCH)/linux-2.6.cc \


SOURCES_vmcommon = \
	   $(ARCH)/intlogic.cc $(ARCH)/burn.S \
	   $(ARCH)/rewrite_stackless.cc \
	   common/memory.cc common/elfrewrite.cc common/burn_symbols.cc \
	   l4ka/vmcommon/$(ARCH)/backend.cc l4ka/vmcommon/$(ARCH)/prepare.cc \
	   l4ka/vmcommon/$(ARCH)/synchronous.cc l4ka/vmcommon/exports.cc \
	   l4ka/vmcommon/backend.cc l4ka/vmcommon/vcpu.cc 

ifeq "$(CONFIG_L4KA_VM)" "y"
SOURCES += $(SOURCES_vmcommon) l4ka/vm/vm.cc l4ka/vm/irq.cc l4ka/vm/monitor.cc l4ka/vm/user.cc
endif

ifeq "$(CONFIG_L4KA_VMEXT)" "y"
SOURCES += $(SOURCES_vmcommon) l4ka/vmext/vm.cc l4ka/vmext/monitor.cc l4ka/vmext/user.cc
endif

ifeq "$(CONFIG_L4KA_VT)" "y"
afterburn-wedge: $(BUILDDIR)/rombios.elf $(BUILDDIR)/vgabios.elf 

$(BUILDDIR)/%.elf: $(SRCDIR)/../contrib/vbios/%.elf
	@cp -v $< $@

clean::
	@$(RM) $(BUILDDIR)/rombios.elf $(BUILDDIR)/vgabios.elf 

SOURCES += l4ka/vt/vm.cc l4ka/vt/irq.cc l4ka/vt/user.cc l4ka/vt/monitor.cc \
	   l4ka/vt/intlogic.cc l4ka/vt/vcpu.cc l4ka/vt/segdesc.cc \
	   l4ka/vt/helpers.cc \
	   l4ka/vt/backend.cc l4ka/vt/module.cc l4ka/vt/handle_cpuid.cc \
	   l4ka/vt/$(ARCH)/backend.cc 
endif


SOURCES-$(CONFIG_DEVICE_DP83820) += l4ka/dp83820.cc
SOURCES-$(CONFIG_DEVICE_PCI_FORWARD) += l4ka/pci_forward.cc

IDL_SOURCES += resourcemon_idl.idl L4VMblock_idl.idl
IDL_SOURCES-$(CONFIG_DEVICE_DP83820) += L4VMnet_idl.idl lanaddress_idl.idl
IDL_SOURCES-$(CONFIG_DEVICE_PCI_FORWARD) += L4VMpci_idl.idl


